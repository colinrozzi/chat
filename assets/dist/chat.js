var Ve=Object.defineProperty;var v=(e,t)=>()=>(e&&(t=e(e=0)),t);var W=(e,t)=>{for(var n in t)Ve(e,n,{get:t[n],enumerable:!0})};function u(e){return document.getElementById(e)}var o,x=v(()=>{o={messageInput:u("messageInput"),sendButton:u("sendButton"),generateButton:u("generateButton"),messagesContainer:u("messagesContainer"),connectionStatus:u("connectionStatus"),loadingOverlay:u("loadingOverlay"),headId:u("headId"),chatSidebar:u("chatSidebar"),chatList:u("chatList"),currentChatName:u("currentChatName"),newChatButton:u("newChatButton"),branchChatButton:u("branchChatButton"),collapseChatSidebarButton:u("collapseChatSidebarButton"),expandChatSidebarButton:u("expandChatSidebarButton"),chatControlsSidebar:u("chatControlsSidebar"),collapseChatControlsButton:u("collapseChatControlsButton"),expandChatControlsButton:u("expandChatControlsButton"),controlsModelSelector:u("controlsModelSelector"),modelContextWindow:u("modelContextWindow"),modelInfo:u("modelInfo"),statsMessageCount:u("statsMessageCount"),statsTokenCount:u("statsTokenCount"),statsTotalCost:u("statsTotalCost")}});var Re={};W(Re,{initializeSidebars:()=>fe,renderEmptyState:()=>K,scrollToBottom:()=>I,showCopySuccess:()=>ee,showError:()=>m,showSuccess:()=>Z,toggleChatControlsSidebar:()=>oe,toggleChatSidebar:()=>te,toggleSection:()=>Je,updateConnectionStatus:()=>P,updateCurrentChatName:()=>O,updateStatsDisplay:()=>$,updateTotalCostDisplay:()=>Ne});function P(e){o.connectionStatus.className="connection-status "+e,o.connectionStatus.innerHTML=`
    <div class="status-indicator"></div>
    <span>${e.charAt(0).toUpperCase()+e.slice(1)}</span>
  `;let t=e==="connected";o.sendButton.disabled=!t||!o.messageInput.value.trim(),o.generateButton.disabled=!t,t&&window.messageChain.length===0&&(o.generateButton.disabled=!0)}function m(e){console.error("Error:",e);let t=document.createElement("div");t.className="error-message",t.innerHTML=`
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="8" x2="12" y2="12"></line>
      <line x1="12" y1="16" x2="12.01" y2="16"></line>
    </svg>
    ${e}
  `,o.messagesContainer.prepend(t),setTimeout(()=>t.remove(),5e3),o.loadingOverlay.classList.remove("visible")}function Z(e){console.log("Success:",e);let t=document.createElement("div");t.className="success-message",t.innerHTML=`
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
      <polyline points="22 4 12 14.01 9 11.01"></polyline>
    </svg>
    ${e}
  `,o.messagesContainer.prepend(t),setTimeout(()=>t.remove(),2e3)}function ee(e){let t=document.createElement("div");t.className="success-message",t.innerHTML=`
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
      <polyline points="22 4 12 14.01 9 11.01"></polyline>
    </svg>
    ${e}
  `,o.messagesContainer.prepend(t),setTimeout(()=>t.remove(),2e3)}function O(){let e=window.chats.find(t=>t.id===window.currentChatId);if(console.log("Updating current chat name:",e),e){let t=e.name||"Unnamed Chat";o.currentChatName.textContent=t,o.currentChatName.title=`${t} (Click to rename)`,o.currentChatName.onclick=()=>{window.currentChatId&&window.showRenameChat(window.currentChatId,o.currentChatName.textContent)},o.currentChatName.classList.add("editable")}else console.log("No current chat selected"),o.currentChatName.textContent="No Chat Selected",o.currentChatName.title="No Chat Selected",o.currentChatName.onclick=null,o.currentChatName.classList.remove("editable")}function $(){Ne(),o.statsMessageCount&&(o.statsMessageCount.textContent=window.totalMessages),o.statsTokenCount&&(o.statsTokenCount.textContent=`${window.totalInputTokens} in / ${window.totalOutputTokens} out`),o.statsTotalCost&&(o.statsTotalCost.textContent=`${window.totalCost.toFixed(4)}`)}function Ne(){let e=document.querySelector(".cost-value");e&&(e.textContent=`${window.totalCost.toFixed(4)}`)}function I(){o.messagesContainer.scrollTop=o.messagesContainer.scrollHeight}function fe(){window.innerWidth>768&&o.chatControlsSidebar&&(o.chatControlsSidebar.classList.add("collapsed"),o.expandChatControlsButton&&o.expandChatControlsButton.classList.add("visible"))}function te(){o.chatSidebar&&(o.chatSidebar.classList.toggle("collapsed"),o.expandChatSidebarButton&&(o.chatSidebar.classList.contains("collapsed")?o.expandChatSidebarButton.classList.add("visible"):o.expandChatSidebarButton.classList.remove("visible")))}function oe(){o.chatControlsSidebar&&(o.chatControlsSidebar.classList.toggle("collapsed"),o.expandChatControlsButton&&(o.chatControlsSidebar.classList.contains("collapsed")?o.expandChatControlsButton.classList.add("visible"):o.expandChatControlsButton.classList.remove("visible")))}function Je(e){document.getElementById(e).closest(".section").classList.toggle("collapsed")}function K(){return`
    <div class="empty-state">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </svg>
      <p>No messages yet</p>
      <p class="text-sm">Start a conversation!</p>
    </div>
  `}var _=v(()=>{x();g()});function X(){console.log("Sorting message chain:",{chainLength:p.length,currentHead:w});let e={};p.forEach(s=>{e[s.id]=s});let t=new Set,n=[],a=new Set;function i(s,c=0){if(console.log(`Processing message: ${s.id} at level ${c}`),t.has(s.id)){console.log(`- Already visited ${s.id}, skipping`);return}if(t.add(s.id),s.parents&&s.parents.length>0){console.log(`- Message ${s.id} has ${s.parents.length} parents`);for(let d of s.parents){let r=e[d];r?(console.log(`- Processing parent: ${d}`),i(r,c+1)):(console.log(`- MISSING PARENT: ${d} for message ${s.id}`),a.add(d))}}else console.log(`- Message ${s.id} has no parents`);n.push(s)}return w&&e[w]?(console.log(`Starting traversal from head: ${w}`),i(e[w])):(console.log("No current head or head not found in message chain"),console.log("Processing all messages as fallback"),p.forEach(s=>{t.has(s.id)||i(s)})),a.size>0&&console.warn("MISSING PARENTS DETECTED:",Array.from(a)),console.log(`Sorted message chain: ${n.length} messages`),n}var Ce=v(()=>{g()});function we(e){if(!e)return"";let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");return t=t.replace(/```([^`]+)```/g,(n,a)=>`<pre><code>${a}</code></pre>`),t=t.replace(/`([^`]+)`/g,(n,a)=>`<code>${a}</code>`),t=t.replace(/\n/g,"<br>"),t}var He=v(()=>{});var se={};W(se,{calculateMessageCost:()=>je,findLastUsedModel:()=>_e,getModelMaxTokens:()=>Y,getModelPricing:()=>ne});function _e(){let e=X();for(let t=e.length-1;t>=0;t--){let n=e[t];if(n.data&&n.data.Chat&&n.data.Chat.Assistant){let a=n.data.Chat.Assistant,i;if(a.Claude?i=a.Claude.model:a.Gemini?i=a.Gemini.model:a.OpenRouter?i=a.OpenRouter.model:i=a.model,i)return console.log(`Found last used model: ${i}`),A(i),i}}return console.log("No assistant message found in the chain, no lastUsedModelId set"),null}function Y(e){let t=f.find(n=>n.id===e);if(t&&t.max_tokens)return t.max_tokens;if(e?.includes("/")&&(e==="meta-llama/llama-4-maverick:free"||e==="llama-4-maverick:free"||e==="llama-4-maverick-free"))return 1e6;switch(e){case"gemini-2.0-flash":case"gemini-2.0-pro":return 32768;case"claude-3-7-sonnet-20250219":return 8192;case"claude-3-5-sonnet-20241022":case"claude-3-5-haiku-20241022":case"claude-3-5-sonnet-20240620":return 8192;case"claude-3-opus-20240229":case"claude-3-sonnet-20240229":case"claude-3-haiku-20240307":return 4096;case"claude-2.1":case"claude-2.0":return 4096;default:return 4096}}function ne(e){if(e?.startsWith("gemini-")){if(e==="gemini-2.0-flash")return{inputCost:.35,outputCost:1.05};if(e==="gemini-2.0-pro")return{inputCost:3.5,outputCost:10.5}}if(e?.includes("/"))return e==="meta-llama/llama-4-maverick:free"||e==="llama-4-maverick:free"||e==="llama-4-maverick-free"?{inputCost:0,outputCost:0}:{inputCost:null,outputCost:null};switch(e){case"claude-3-7-sonnet-20250219":return{inputCost:3,outputCost:15};case"claude-3-5-sonnet-20241022":case"claude-3-5-sonnet-20240620":return{inputCost:3,outputCost:15};case"claude-3-5-haiku-20241022":return{inputCost:.8,outputCost:4};case"claude-3-opus-20240229":return{inputCost:15,outputCost:75};case"claude-3-sonnet-20240229":return{inputCost:3,outputCost:15};case"claude-3-haiku-20240307":return{inputCost:.25,outputCost:1.25};default:return{inputCost:null,outputCost:null}}}function je(e,t=!1,n=null){n=n||C||"claude-3-7-sonnet-20250219";let a=ne(n);if(a.inputCost===null||a.outputCost===null)return"Unknown";let i=e.input_tokens||e.prompt_tokens||0,s=e.output_tokens||e.completion_tokens||0,c=i/1e6*a.inputCost,d=s/1e6*a.outputCost,r=c+d;return t&&(B(M+r),N(S+i),R(b+s),H(y+1),$()),r.toFixed(4)}var D=v(()=>{g();Ce();_()});var We={};W(We,{addTypingIndicator:()=>Ke,removeTypingIndicator:()=>ve});function Ke(){let e=document.createElement("div");e.className="typing-indicator",e.id="typingIndicator",e.innerHTML=`
    <div class="typing-dots">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  `,o.messagesContainer.appendChild(e),I()}function ve(){let e=document.getElementById("typingIndicator");e&&e.remove()}var ae=v(()=>{x();_()});var ce={};W(ce,{branchChat:()=>xe,confirmDeleteChat:()=>Qe,createNewChat:()=>ke,generateLlmResponse:()=>le,renderChatList:()=>L,renderMessage:()=>Oe,renderMessages:()=>ie,sendMessage:()=>re,showRenameChat:()=>Ye,switchChat:()=>Xe});function ie(){let e=X();o.messagesContainer.innerHTML=e.length?e.map(Oe).join(""):K(),o.generateButton.disabled=e.length===0}function Oe(e){if(console.log("Rendering message:",e,"Message data:",JSON.stringify(e.data,null,2)),e.data.Chat){let t=e.data.Chat;if(t.User)return`
        <div class="message user ${t.User.content.length<80?"small":""}" data-message-id="${e.id}">
          ${we(t.User.content)}
          <div class="message-actions">
            <button class="message-action-button" onclick="window.copyMessageText('${e.id}')">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              <span>Copy Text</span>
            </button>
            <div class="action-divider"></div>
            <button class="message-action-button" onclick="window.copyMessageId('${e.id}')">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
              </svg>
              <span>Copy ID</span>
            </button>
          </div>
        </div>
      `;if(t.Assistant){let n=t.Assistant,a,i,s,c,d,r;if(n.Claude){let l=n.Claude;if(a=l.content,i=l.model,s=l.usage,c=l.stop_reason,d="Claude",l.input_cost_per_million_tokens!==null&&l.output_cost_per_million_tokens!==null){let J=l.usage.input_tokens/1e6*l.input_cost_per_million_tokens,j=l.usage.output_tokens/1e6*l.output_cost_per_million_tokens;r=(J+j).toFixed(4)}else r="Unknown"}else if(n.Gemini){let l=n.Gemini;if(a=l.content,i=l.model,s=l.usage,c=l.finish_reason,d="Gemini",l.input_cost_per_million_tokens!==null&&l.output_cost_per_million_tokens!==null){let J=l.usage.prompt_tokens/1e6*l.input_cost_per_million_tokens,j=l.usage.completion_tokens/1e6*l.output_cost_per_million_tokens;r=(J+j).toFixed(4)}else r="Unknown"}else if(n.OpenRouter){let l=n.OpenRouter;if(a=l.content,i=l.model,s=l.usage,c=l.finish_reason,d="OpenRouter",l.input_cost_per_million_tokens!==null&&l.output_cost_per_million_tokens!==null){let J=l.usage.prompt_tokens/1e6*l.input_cost_per_million_tokens,j=l.usage.completion_tokens/1e6*l.output_cost_per_million_tokens;r=(J+j).toFixed(4)}else l.usage.cost!==null?r=l.usage.cost.toFixed(4):r="Unknown"}else a=n.content||"Content unavailable",i=n.model||"Unknown model",s=n.usage||{input_tokens:0,output_tokens:0},c=n.stop_reason||n.finish_reason||"Unknown",d=i?.startsWith("gemini-")?"Gemini":"Claude",r="Unknown";return`
        <div class="message assistant ${a?.length<100?"small":""}" data-message-id="${e.id}">
          ${we(a)}
          <div class="message-actions">
            <button class="message-action-button" onclick="window.copyMessageText('${e.id}')">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              <span>Copy Text</span>
            </button>
            <div class="action-divider"></div>
            <button class="message-action-button" onclick="window.copyMessageId('${e.id}')">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
              </svg>
              <span>Copy ID</span>
            </button>
          </div>
          <div class="message-metadata">
            <div class="metadata-item">
              <span class="metadata-label">Provider:</span> ${d}
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Model:</span> ${i}
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Tokens:</span> ${s&&(s.input_tokens||s.prompt_tokens)||0} in / ${s&&(s.output_tokens||s.completion_tokens)||0} out of ${Y(i)}
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Cost:</span> ${r}
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Stop Reason:</span> ${c}
            </div>
          </div>
        </div>
      `}}return""}function L(){let e=[...T].sort((t,n)=>t.updated_at&&n.updated_at?n.updated_at-t.updated_at:t.id.localeCompare(n.id));o.chatList.innerHTML=e.length?e.map(t=>`
      <div class="chat-item ${t.id===q?"active":""}" data-chat-id="${t.id}">
        <div class="chat-item-name" onclick="window.switchChat('${t.id}')">${t.name}</div>
        <div class="chat-item-actions">
          <button class="chat-action rename" onclick="window.showRenameChat('${t.id}', '${t.name}')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </svg>
          </button>
          <button class="chat-action delete" onclick="window.confirmDeleteChat('${t.id}')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18"></path>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      </div>
    `).join(""):'<div class="empty-state">No chats available</div>'}function ke(e){let t=prompt("Enter a name for the new chat:","New Chat");if(t===null)return;if(!t.trim()){m("Chat name cannot be empty");return}if(t.length>50){m("Chat name too long (maximum 50 characters)");return}let n=t.trim();console.log(`Creating new chat with name: "${n}"`),o.loadingOverlay.classList.add("visible");let a="temp-"+Date.now(),i={id:a,name:n,isTemporary:!0},s=[...T,i];Promise.resolve().then(()=>(g(),E)).then(({setChats:d})=>{d(s)}),L();let c=document.querySelector(`.chat-item[data-chat-id="${a}"] .chat-item-name`);c&&(c.innerHTML+=' <span class="loading-text">(Creating...)</span>'),k({type:"create_chat",name:n,starting_head:null},e),Promise.resolve().then(()=>(g(),E)).then(({setMessageChain:d,setCurrentHead:r})=>{d([]),r(null)}),o.messagesContainer.innerHTML=K(),o.headId.textContent="",o.generateButton.disabled=!0,setTimeout(()=>{if(T.some(r=>r.id===a)){let r=T.filter(h=>h.id!==a);Promise.resolve().then(()=>(g(),E)).then(({setChats:h})=>{h(r)}),L(),m("Failed to create chat. Server did not respond.")}o.loadingOverlay.classList.remove("visible")},5e3)}function xe(e){if(!w){m("Cannot branch from an empty chat");return}let t=prompt("Enter a name for the branched chat:","Branch of current chat");t!==null&&k({type:"create_chat",name:t,starting_head:w},e)}function Xe(e,t){e!==q&&(k({type:"switch_chat",chat_id:e},t),Promise.resolve().then(()=>(g(),E)).then(({setMessageChain:n,setCurrentHead:a,setLastUsedModelId:i})=>{n([]),a(null),i(null)}),o.messagesContainer.innerHTML=K(),o.headId.textContent="",o.generateButton.disabled=!0)}function Ye(e,t){let n=t.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"'),a=prompt("Enter a new name for the chat:",n);if(a===null||a===n)return;if(!a.trim()){m("Chat name cannot be empty");return}if(a.length>50){m("Chat name too long (maximum 50 characters)");return}console.log(`Renaming chat ${e} from "${t}" to "${a.trim()}"`);let i=document.querySelector(`.chat-item[data-chat-id="${e}"] .chat-item-name`);if(i){let s=i.textContent;i.textContent="Renaming...",setTimeout(()=>{i.textContent==="Renaming..."&&(i.textContent=s)},3e3)}k({type:"rename_chat",chat_id:e,name:a.trim()},window.ws)}function Qe(e){let t=T.find(i=>i.id===e),n=t?t.name:"this chat";confirm(`Are you sure you want to delete "${n}"?

This action cannot be undone.`)&&k({type:"delete_chat",chat_id:e},window.ws)}function re(e){let t=o.messageInput.value.trim();if(!t||!e||e.readyState!==WebSocket.OPEN||window.isWaitingForResponse)return;console.log("Sending user message:",{messageLength:t.length,messageChainLength:p.length,currentHead:w});let n={id:"temp-"+Date.now(),data:{Chat:{User:{content:t}}}},a=[...p,n];Promise.resolve().then(()=>(g(),E)).then(({setMessageChain:i})=>{i(a)}),console.log("Added temporary message to chain, new length:",a.length),ie(),I(),o.messageInput.value="",o.messageInput.style.height="auto",o.messageInput.focus(),o.sendButton.disabled=!0,o.generateButton.disabled=!1,console.log("Sending WebSocket message with user content"),k({type:"send_message",content:t},e)}function le(e,t){!e||e.readyState!==WebSocket.OPEN||window.isWaitingForResponse||(t||(t=o.controlsModelSelector?.value),t&&Promise.resolve().then(()=>(g(),E)).then(({setLastUsedModelId:n})=>{n(t),console.log(`Set lastUsedModelId to: ${t}`)}),console.log("Generating LLM response:",{model:t,messageChainLength:p.length,currentHead:w,sortedChainLength:X().length}),Promise.resolve().then(()=>(g(),E)).then(({setIsWaitingForResponse:n})=>{n(!0)}),o.sendButton.disabled=!0,o.generateButton.disabled=!0,Promise.resolve().then(()=>(ae(),We)).then(({addTypingIndicator:n})=>{n(),I()}),console.log("Sending WebSocket message to generate LLM response"),k({type:"generate_llm_response",model_id:t},e))}var U=v(()=>{g();x();Ce();He();_();D();z();_()});var De={};W(De,{populateModelSelector:()=>Me,updateModelInfo:()=>F,updateModelSelector:()=>Ze});function Me(){if(!o.controlsModelSelector||!f||f.length===0)return;let e=o.controlsModelSelector.value,t=f.filter(r=>!r.provider||r.provider==="claude"),n=f.filter(r=>r.provider==="gemini"),a=f.filter(r=>r.provider==="openrouter"),i=[...t].sort((r,h)=>r.id==="claude-3-7-sonnet-20250219"?-1:h.id==="claude-3-7-sonnet-20250219"?1:h.id.localeCompare(r.id));o.controlsModelSelector.innerHTML="";let s=document.createElement("optgroup");s.label="Claude Models",i.forEach(r=>{let h=document.createElement("option");h.value=r.id,h.textContent=r.display_name,s.appendChild(h)});let c=document.createElement("optgroup");c.label="Gemini Models",n.forEach(r=>{let h=document.createElement("option");h.value=r.id,h.textContent=r.display_name,c.appendChild(h)});let d=document.createElement("optgroup");d.label="OpenRouter Models",a.forEach(r=>{let h=document.createElement("option");h.value=r.id,h.textContent=r.display_name,d.appendChild(h)}),o.controlsModelSelector.appendChild(s),o.controlsModelSelector.appendChild(c),o.controlsModelSelector.appendChild(d),C&&f.some(r=>r.id===C)?(o.controlsModelSelector.value=C,console.log(`Set model selector to last used model: ${C}`)):e&&f.some(r=>r.id===e)?(o.controlsModelSelector.value=e,console.log(`Restored previous selection: ${e}`)):f.length>0&&(o.controlsModelSelector.value=f[0].id,console.log(`Defaulted to first model: ${f[0].id}`)),F()}function Ze(){!C||!o.controlsModelSelector||(f.some(e=>e.id===C)?(console.log(`Setting model selector to last used model: ${C}`),o.controlsModelSelector.value=C,F()):console.log(`Last used model ${C} not found in available models`))}function F(){if(!o.controlsModelSelector||!o.modelContextWindow)return;let e=o.controlsModelSelector.value,t=Y(e),n=document.getElementById("modelInfo");o.modelContextWindow.textContent=new Intl.NumberFormat().format(t)+" tokens";let a=n.querySelector(".info-value:not(#modelContextWindow)");if(a){let i=ne(e);i.inputCost===null||i.outputCost===null?a.textContent="Cost information unavailable":i.inputCost===0&&i.outputCost===0?a.textContent="Free":a.textContent="$"+ +i.inputCost.toFixed(2)+" / "+i.outputCost.toFixed(2)+" per 1M tokens (in/out)"}}var de=v(()=>{g();x();D()});function Ae(e,t){console.log("Handling new message:",e),console.log("Message chain before handling:",{length:p.length,ids:p.map(i=>i.id),currentHead:window.currentHead});let n=p.filter(i=>i.id.startsWith("temp-")).length,a=p.filter(i=>!i.id.startsWith("temp-"));if(ue(a),console.log(`Removed ${n} temporary messages`),p.find(i=>i.id===e.id))console.log(`Message ${e.id} already exists in chain, skipping`);else{if(console.log(`Adding new message to chain: ${e.id}, parents: ${JSON.stringify(e.parents||[])}`),e.data&&e.data.Chat&&e.data.Chat.Assistant){let i=e.data.Chat.Assistant;if(i.Claude){let s=i.Claude;if(s.input_cost_per_million_tokens!==void 0&&s.output_cost_per_million_tokens!==void 0){if(s.input_cost_per_million_tokens!==null&&s.output_cost_per_million_tokens!==null){let c=s.usage.input_tokens/1e6*s.input_cost_per_million_tokens,d=s.usage.output_tokens/1e6*s.output_cost_per_million_tokens;B(M+(c+d)),N(S+s.usage.input_tokens),R(b+s.usage.output_tokens),H(y+1),$()}}else Promise.resolve().then(()=>(D(),se)).then(({calculateMessageCost:c})=>{c(s.usage,!0,s.model)});A(s.model),console.log(`Stored last used model ID: ${s.model}`)}else if(i.Gemini){let s=i.Gemini;if(s.input_cost_per_million_tokens!==void 0&&s.output_cost_per_million_tokens!==void 0){if(s.input_cost_per_million_tokens!==null&&s.output_cost_per_million_tokens!==null){let c=s.usage.prompt_tokens/1e6*s.input_cost_per_million_tokens,d=s.usage.completion_tokens/1e6*s.output_cost_per_million_tokens;B(M+(c+d)),N(S+s.usage.prompt_tokens),R(b+s.usage.completion_tokens),H(y+1),$()}}else Promise.resolve().then(()=>(D(),se)).then(({calculateMessageCost:c})=>{c(s.usage,!0,s.model)});A(s.model),console.log(`Stored last used model ID: ${s.model}`)}else if(i.OpenRouter){let s=i.OpenRouter;if(s.input_cost_per_million_tokens!==void 0&&s.output_cost_per_million_tokens!==void 0)if(s.input_cost_per_million_tokens!==null&&s.output_cost_per_million_tokens!==null){let c=s.usage.prompt_tokens/1e6*s.input_cost_per_million_tokens,d=s.usage.completion_tokens/1e6*s.output_cost_per_million_tokens;B(M+(c+d)),N(S+s.usage.prompt_tokens),R(b+s.usage.completion_tokens),H(y+1),$()}else s.usage.cost!==null&&(B(M+s.usage.cost),N(S+(s.usage.prompt_tokens||0)),R(b+(s.usage.completion_tokens||0)),H(y+1),$());else Promise.resolve().then(()=>(D(),se)).then(({calculateMessageCost:c})=>{c(s.usage,!0,s.model)});A(s.model),console.log(`Stored last used model ID: ${s.model}`)}Promise.resolve().then(()=>(de(),De)).then(({updateModelSelector:s})=>{s()})}ue([...p,e])}if(e.parents&&e.parents.length>0){console.log(`Message has ${e.parents.length} parents: ${JSON.stringify(e.parents)}`);for(let i of e.parents)p.find(s=>s.id===i)?console.log(`Parent already in chain: ${i}`):(console.log(`Requesting missing parent: ${i}`),pe(i,t))}else console.log("Message has no parents");Se(!1),ve(),o.sendButton.disabled=!o.messageInput.value.trim(),o.generateButton.disabled=p.length===0,ie(),I()}var Ue=v(()=>{g();x();z();U();_();_();ae()});function Fe(e,t){switch(console.log("Processing message:",e),e.type){case"messages_updated":case"head":et(e,t);break;case"message":e.message&&Ae(e.message,t);break;case"chats_update":tt(e);break;case"chat_created":ot(e);break;case"chat_renamed":nt(e);break;case"chat_deleted":st(e);break;case"models_list":at(e);break;case"error":it(e);break}}function et(e,t){e.current_chat_id&&e.current_chat_id!==window.currentChatId&&(Q(e.current_chat_id),O(),L()),e.head&&e.head!==window.currentHead&&(console.log(`Head updated: ${window.currentHead} -> ${e.head}`),be(e.head),o.headId.textContent=`Head: ${e.head.substring(0,8)}...`,pe(e.head,t),_e(),o.generateButton.disabled=!1)}function tt(e){e.chats&&(V(e.chats),e.current_chat_id&&Q(e.current_chat_id),L(),O())}function ot(e){if(e.chat){console.log("Received chat_created event:",e.chat);let t=window.chats.filter(n=>!n.isTemporary);if(!t.find(n=>n.id===e.chat.id))t.push(e.chat),console.log(`Added new chat to chats array: ${e.chat.id} - ${e.chat.name}`);else{console.log(`Chat already exists in array, updating: ${e.chat.id}`);let n=t.findIndex(a=>a.id===e.chat.id);n!==-1&&(t[n]={...t[n],...e.chat,name:e.chat.name||t[n].name,icon:e.chat.icon!==void 0?e.chat.icon:t[n].icon})}V(t),Q(e.chat.id),window.messageChain.length>0&&Promise.resolve().then(()=>(g(),E)).then(({resetState:n})=>{n(),o.messagesContainer.innerHTML=rt(),o.headId.textContent="",o.generateButton.disabled=!0}),o.loadingOverlay.classList.remove("visible"),L(),O(),Z(`Chat "${e.chat.name}" created successfully`)}else console.error("Received chat_created event without chat data"),m("Error creating chat: Invalid response from server")}function nt(e){if(e.chat){console.log("Received chat_renamed event:",e.chat);let t=[...window.chats],n=t.findIndex(a=>a.id===e.chat.id);if(n!==-1){let a=t[n].name;t[n]={...t[n],name:e.chat.name||t[n].name,icon:e.chat.icon!==void 0?e.chat.icon:t[n].icon},console.log(`Updated chat in array: ${t[n].id} renamed from "${a}" to "${t[n].name}"`),V(t),L(),O(),Z(`Chat renamed to "${t[n].name}" successfully`)}else console.warn("Received rename event for non-existent chat ID:",e.chat.id),m("Error: Chat not found")}else console.error("Received chat_renamed event without chat data"),m("Error renaming chat: Invalid response from server")}function st(e){if(e.chat_id){let t=window.chats.filter(n=>n.id!==e.chat_id);V(t),L(),O()}}function at(e){e.models&&(ye(e.models),Me(),F())}function it(e){console.error("Error from server:",e),e.error_code==="rename_chat_failed"?m(e.message||"Failed to rename chat"):e.error_code==="create_chat_failed"?m(e.message||"Failed to create chat"):m(e.message||"An error occurred"),o.loadingOverlay.classList.remove("visible")}function rt(){return`
    <div class="empty-state">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </svg>
      <p>No messages yet</p>
      <p class="text-sm">Start a conversation!</p>
    </div>
  `}var Ge=v(()=>{g();x();_();U();de();D();z();Ue();ae();_()});function Te(){console.log("Connecting to WebSocket..."),P("connecting");let e=8084;window.location&&window.location.port&&(e=window.location.port),console.log(`Attempting to connect to WebSocket on port ${e}`);let t=new WebSocket(`ws://localhost:${e}/ws`);return t.onopen=()=>{console.log("WebSocket connected"),P("connected"),me(0),k({type:"list_chats"},t),k({type:"get_head"},t),k({type:"list_models"},t)},t.onclose=()=>{console.log("WebSocket disconnected"),P("disconnected"),o.sendButton.disabled=!0,o.generateButton.disabled=!0,G<Ee&&(me(G+1),setTimeout(Te,Le*Math.min(G+1,30)))},t.onmessage=n=>{try{let a=JSON.parse(n.data);console.log("Received WebSocket message:",a),a.type==="messages_updated"||a.type==="head"?console.log("HEAD UPDATE - Before processing:",{oldHead:window.currentHead,newHead:a.head,messageChainLength:window.messageChain?.length||0,messageIDs:window.messageChain?.map(i=>i.id)||[]}):a.type==="message"&&console.log("MESSAGE RECEIVED - Details:",{messageId:a.message?.id,messageParents:a.message?.parents,messageType:a.message?.data?Object.keys(a.message.data)[0]:"unknown",currentChainLength:window.messageChain?.length||0}),(a.type==="head"||a.type==="messages_updated")&&console.log("Window state before processing message:",{messageChain:window.messageChain?"defined":"undefined",currentHead:window.currentHead!==void 0?"defined":"undefined",chats:window.chats?"defined":"undefined",models:window.models?"defined":"undefined"}),Fe(a,t)}catch(a){console.error("WebSocket message processing error:",a),console.error("Raw message:",n.data),m("Failed to process server message")}},t.onerror=n=>{console.error("WebSocket error:",n),console.error(`Failed to connect to WebSocket on port ${e}`),m(`Connection error: Failed to connect on port ${e}. Check your server is running.`),P("disconnected"),o.sendButton.disabled=!0,o.generateButton.disabled=!0},t}function k(e,t){if(t?.readyState===WebSocket.OPEN){let n=JSON.stringify(e);console.log("Sending WebSocket message:",e),t.send(n)}else console.error("Cannot send message: WebSocket not connected",e),m("Not connected to server")}function pe(e,t){k({type:"get_message",message_id:e},t)}var z=v(()=>{g();x();_();Ge()});var E={};W(E,{MAX_RECONNECT_ATTEMPTS:()=>Ee,RECONNECT_DELAY:()=>Le,chats:()=>T,currentChatId:()=>q,currentHead:()=>w,initializeApp:()=>$e,isWaitingForResponse:()=>he,lastUsedModelId:()=>C,messageChain:()=>p,models:()=>f,reconnectAttempts:()=>G,resetState:()=>lt,setChats:()=>V,setCurrentChatId:()=>Q,setCurrentHead:()=>be,setIsWaitingForResponse:()=>Se,setLastUsedModelId:()=>A,setMessageChain:()=>ue,setModels:()=>ye,setReconnectAttempts:()=>me,setTotalCost:()=>B,setTotalInputTokens:()=>N,setTotalMessages:()=>H,setTotalOutputTokens:()=>R,setWs:()=>ze,totalCost:()=>M,totalInputTokens:()=>S,totalMessages:()=>y,totalOutputTokens:()=>b,ws:()=>Pe});function ue(e){p=e,window.messageChain=e}function be(e){w=e,window.currentHead=e}function Q(e){q=e,window.currentChatId=e}function V(e){T=e,window.chats=e}function ye(e){f=e,window.models=e}function ze(e){Pe=e,window.ws=e}function me(e){G=e,window.reconnectAttempts=e}function B(e){M=e,window.totalCost=e}function A(e){C=e,window.lastUsedModelId=e}function Se(e){he=e,window.isWaitingForResponse=e}function N(e){S=e}function R(e){b=e}function H(e){y=e}function lt(){p=[],w=null,C=null,he=!1,window.messageChain=[],window.currentHead=null,window.lastUsedModelId=null,window.isWaitingForResponse=!1}function $e(){console.log("Initializing chat application..."),fe();let e=Te();ze(e),console.log("Global state initialization:",{windowMessageChain:window.messageChain?"defined":"undefined",windowCurrentHead:window.currentHead!==void 0?"defined":"undefined",windowChats:window.chats?"defined":"undefined",windowWS:window.ws?"defined":"undefined"}),console.log("Application initialization complete")}var p,w,q,T,f,Pe,G,M,C,he,Ee,Le,S,b,y,g=v(()=>{z();x();_();p=[],w=null,q=null,T=[],f=[],Pe=null,G=0,M=0,C=null,he=!1;window.messageChain=p;window.currentHead=w;window.currentChatId=q;window.chats=T;window.models=f;window.ws=null;window.reconnectAttempts=G;window.totalCost=M;window.lastUsedModelId=C;window.isWaitingForResponse=he;Ee=5,Le=1e3,S=0,b=0,y=0});var Ie={};W(Ie,{copyMessageId:()=>dt,copyMessageText:()=>ct});function ct(e){let t=p.find(a=>a.id===e);if(!t)return;let n="";if(t.data.Chat){if(t.data.Chat.User)n=t.data.Chat.User.content;else if(t.data.Chat.Assistant){let a=t.data.Chat.Assistant;a.Claude?n=a.Claude.content:a.Gemini?n=a.Gemini.content:a.OpenRouter?n=a.OpenRouter.content:n=a.content||""}}navigator.clipboard.writeText(n).then(()=>{ee("Text copied to clipboard")}).catch(a=>{console.error("Failed to copy text: ",a),m("Failed to copy text")})}function dt(e){navigator.clipboard.writeText(e).then(()=>{ee("ID copied to clipboard")}).catch(t=>{console.error("Failed to copy ID: ",t),m("Failed to copy ID")})}var ge=v(()=>{g();_()});g();x();z();U();_();ge();de();function qe(){console.log("Setting up event listeners..."),o.messageInput?.addEventListener("input",()=>{o.messageInput.style.height="auto",o.messageInput.style.height=Math.min(o.messageInput.scrollHeight,120)+"px",o.sendButton.disabled=!o.messageInput.value.trim()}),document.addEventListener("keydown",e=>{e.key==="\\"&&(e.preventDefault(),o.messageInput?.focus())}),o.messageInput?.addEventListener("keydown",e=>{e.key==="Enter"&&(e.shiftKey?(e.preventDefault(),console.log("Sending message with Shift+Enter"),re(window.ws)):(e.ctrlKey||e.metaKey)&&(e.preventDefault(),console.log("Generating response with Ctrl/Cmd+Enter"),le(window.ws)))}),o.sendButton?.addEventListener("click",()=>re(window.ws)),o.generateButton?.addEventListener("click",()=>le(window.ws)),o.collapseChatSidebarButton?.addEventListener("click",te),o.expandChatSidebarButton?.addEventListener("click",te),o.collapseChatControlsButton?.addEventListener("click",oe),o.expandChatControlsButton?.addEventListener("click",oe),o.controlsModelSelector?.addEventListener("change",F),o.newChatButton?.addEventListener("click",()=>ke(window.ws)),o.branchChatButton?.addEventListener("click",()=>xe(window.ws)),window.switchChat=e=>Promise.resolve().then(()=>(U(),ce)).then(t=>t.switchChat(e,window.ws)),window.showRenameChat=(e,t)=>Promise.resolve().then(()=>(U(),ce)).then(n=>n.showRenameChat(e,t)),window.confirmDeleteChat=e=>Promise.resolve().then(()=>(U(),ce)).then(t=>t.confirmDeleteChat(e)),window.copyMessageText=e=>Promise.resolve().then(()=>(ge(),Ie)).then(t=>t.copyMessageText(e)),window.copyMessageId=e=>Promise.resolve().then(()=>(ge(),Ie)).then(t=>t.copyMessageId(e)),window.toggleSection=e=>Promise.resolve().then(()=>(_(),Re)).then(t=>t.toggleSection(e)),console.log("Event listeners setup complete")}function ut(){window.ws&&window.ws.close()}window.addEventListener("unload",ut);x();function Be(){window.innerWidth<=768?(o.chatSidebar&&(o.chatSidebar.classList.add("collapsed"),o.expandChatSidebarButton&&o.expandChatSidebarButton.classList.add("visible")),o.chatControlsSidebar&&(o.chatControlsSidebar.classList.add("collapsed"),o.expandChatControlsButton&&o.expandChatControlsButton.classList.add("visible"))):window.innerWidth<=1200&&o.chatControlsSidebar&&(o.chatControlsSidebar.classList.add("collapsed"),o.expandChatControlsButton&&o.expandChatControlsButton.classList.add("visible"))}document.addEventListener("DOMContentLoaded",()=>{$e(),qe(),Be(),window.addEventListener("resize",Be)});
//# sourceMappingURL=chat.js.map
